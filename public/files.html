<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>File Sharing - Raspberry Pi</title>
    <link rel="stylesheet" href="css/files.css" />
    <link rel="stylesheet" href="css/cockpit.css" />
  </head>
  <body>
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>ğŸ¥§ Pi Cockpit</h1>
        <div class="subtitle">Raspberry Pi Server</div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <a href="/cockpit" class="nav-link">
            <span class="nav-link-icon">ğŸ“Š</span>
            <span>Dashboard</span>
          </a>
          <a href="/users" class="nav-link">
            <span class="nav-link-icon">ğŸ‘¥</span>
            <span>User Management</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Pages</div>
          <a href="/files" class="nav-link active">
            <span class="nav-link-icon">ğŸ“</span>
            <span>Files</span>
          </a>
          <a href="/game" class="nav-link">
            <span class="nav-link-icon">ğŸ®</span>
            <span>Game</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Admin Pages</div>
          <a href="/game-admin" class="nav-link">
            <span class="nav-link-icon">âš™ï¸</span>
            <span>Game Admin</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container">
        <div class="header">
          <h1>ğŸ“ File Sharing</h1>
          <div class="header-buttons">
            <span
              id="user-status"
              style="
                margin-right: 10px;
                color: #333;
                font-size: 14px;
                font-weight: 600;
              "
            ></span>
          </div>
        </div>

        <div class="upload-section">
          <h2>ğŸ“¤ Datei hochladen</h2>
          <div id="message-container"></div>
          <form class="upload-form" id="upload-form">
            <label class="file-input-wrapper" for="file-input">
              <div>
                <span style="font-size: 48px">ğŸ“</span>
                <p style="margin-top: 10px; font-weight: 600; color: #667eea">
                  Klicken Sie hier, um eine Datei auszuwÃ¤hlen
                </p>
                <p style="margin-top: 5px; font-size: 14px; color: #999">
                  oder ziehen Sie eine Datei hierher
                </p>
                <p
                  id="upload-as-info"
                  style="margin-top: 10px; font-size: 12px; color: #666"
                ></p>
              </div>
              <input type="file" id="file-input" />
              <div class="file-info" id="file-info"></div>
            </label>
            <button type="submit" class="btn-upload" id="upload-btn" disabled>
              Hochladen
            </button>
          </form>
        </div>

        <div class="files-section">
          <h2>ğŸ“‚ Geteilte Dateien</h2>
          <div id="file-list" class="file-list">
            <div class="empty-state">Lade Dateien...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let selectedFile = null;
      let currentUser = null;

      const fileInput = document.getElementById("file-input");
      const fileInfo = document.getElementById("file-info");
      const uploadBtn = document.getElementById("upload-btn");
      const uploadForm = document.getElementById("upload-form");
      const messageContainer = document.getElementById("message-container");

      // Check login status
      async function checkLoginStatus() {
        try {
          const response = await fetch("/api/whoami");
          const data = await response.json();
          currentUser = data;

          const userStatus = document.getElementById("user-status");
          const uploadAsInfo = document.getElementById("upload-as-info");

          if (data.loggedIn) {
            userStatus.textContent = `ğŸ‘¤ ${data.userId}`;
            uploadAsInfo.textContent = `Hochladen als: ${data.userId}`;
          } else {
            userStatus.textContent = "Anonym";
            uploadAsInfo.textContent =
              "Hochladen als: anonymous (Login fÃ¼r Namensanzeige)";
          }
        } catch (error) {
          console.error("Error checking login status:", error);
        }
      }

      async function logout() {
        try {
          await fetch("/api/logout", { method: "POST" });
          window.location.href = "/";
        } catch (error) {
          console.error("Error during logout:", error);
          window.location.href = "/";
        }
      }

      fileInput.addEventListener("change", (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
          const size = (selectedFile.size / 1024 / 1024).toFixed(2);
          fileInfo.textContent = `AusgewÃ¤hlt: ${selectedFile.name} (${size} MB)`;
          uploadBtn.disabled = false;
        } else {
          fileInfo.textContent = "";
          uploadBtn.disabled = true;
        }
      });

      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("file", selectedFile);

        uploadBtn.disabled = true;
        uploadBtn.textContent = "Wird hochgeladen...";

        try {
          const response = await fetch("/api/files/upload", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            showMessage("Datei erfolgreich hochgeladen!", "success");
            fileInput.value = "";
            selectedFile = null;
            fileInfo.textContent = "";
            uploadBtn.textContent = "Hochladen";
            loadFiles();
          } else {
            const error = await response.text();
            showMessage("Fehler beim Hochladen: " + error, "error");
            uploadBtn.disabled = false;
            uploadBtn.textContent = "Hochladen";
          }
        } catch (error) {
          showMessage("Fehler: " + error.message, "error");
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Hochladen";
        }
      });

      function showMessage(text, type) {
        messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
        setTimeout(() => {
          messageContainer.innerHTML = "";
        }, 5000);
      }

      async function loadFiles() {
        try {
          const response = await fetch("/api/files/list");

          if (!response.ok) {
            throw new Error("Fehler beim Laden der Dateien");
          }

          const files = await response.json();
          displayFiles(files);
        } catch (error) {
          console.error("Error loading files:", error);
          document.getElementById("file-list").innerHTML =
            '<div class="empty-state">Fehler beim Laden der Dateien</div>';
        }
      }

      function displayFiles(files) {
        const fileList = document.getElementById("file-list");

        if (files.length === 0) {
          fileList.innerHTML =
            '<div class="empty-state">Keine Dateien vorhanden</div>';
          return;
        }

        fileList.innerHTML = files
          .map((file) => {
            const date = new Date(file.uploadedAt);
            const size = (file.size / 1024 / 1024).toFixed(2);
            return `
            <div class="file-item">
              <div class="file-info-text">
                <div class="file-name">ğŸ“„ ${file.name}</div>
                <div class="file-meta">
                  ${size} MB â€¢ Hochgeladen von ${
              file.uploadedBy
            } â€¢ ${date.toLocaleDateString("de-DE")} ${date.toLocaleTimeString(
              "de-DE"
            )}
                </div>
              </div>
              <div class="file-actions">
                <button class="btn-download" onclick="downloadFile('${
                  file.name
                }')">
                  â¬‡ï¸ Download
                </button>
                <button class="btn-delete" onclick="deleteFile('${file.name}')">
                  ğŸ—‘ï¸ LÃ¶schen
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      async function downloadFile(filename) {
        window.location.href = `/api/files/download/${encodeURIComponent(
          filename
        )}`;
      }

      async function deleteFile(filename) {
        if (!confirm(`MÃ¶chten Sie "${filename}" wirklich lÃ¶schen?`)) {
          return;
        }

        try {
          const response = await fetch(
            `/api/files/delete/${encodeURIComponent(filename)}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            showMessage("Datei gelÃ¶scht", "success");
            loadFiles();
          } else {
            const error = await response.text();
            showMessage("Fehler beim LÃ¶schen: " + error, "error");
          }
        } catch (error) {
          showMessage("Fehler: " + error.message, "error");
        }
      }

      // Drag and drop
      const wrapper = document.querySelector(".file-input-wrapper");

      wrapper.addEventListener("dragover", (e) => {
        e.preventDefault();
        wrapper.style.borderColor = "#764ba2";
        wrapper.style.background = "#f0f1ff";
      });

      wrapper.addEventListener("dragleave", () => {
        wrapper.style.borderColor = "#667eea";
        wrapper.style.background = "#f8f9ff";
      });

      wrapper.addEventListener("drop", (e) => {
        e.preventDefault();
        wrapper.style.borderColor = "#667eea";
        wrapper.style.background = "#f8f9ff";

        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          selectedFile = e.dataTransfer.files[0];
          const size = (selectedFile.size / 1024 / 1024).toFixed(2);
          fileInfo.textContent = `AusgewÃ¤hlt: ${selectedFile.name} (${size} MB)`;
          uploadBtn.disabled = false;
        }
      });

      // Load files and check login status on page load
      checkLoginStatus();
      loadFiles();

      // Refresh file list every 10 seconds
      setInterval(loadFiles, 10000);
    </script>
  </body>
</html>
