<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>File Sharing - Raspberry Pi</title>
    <link rel="stylesheet" href="css/files.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìÅ File Sharing</h1>
        <div class="header-buttons">
          <span
            id="user-status"
            style="
              margin-right: 10px;
              color: #333;
              font-size: 14px;
              font-weight: 600;
            "
          ></span>
          <a href="/cockpit">üìä Cockpit</a>
          <a href="/game">üéÆ Spiel</a>
          <a href="/" id="login-link">üîê Login</a>
        </div>
      </div>

      <div class="upload-section">
        <h2>üì§ Datei hochladen</h2>
        <div id="message-container"></div>
        <form class="upload-form" id="upload-form">
          <label class="file-input-wrapper" for="file-input">
            <div>
              <span style="font-size: 48px">üìé</span>
              <p style="margin-top: 10px; font-weight: 600; color: #667eea">
                Klicken Sie hier, um eine Datei auszuw√§hlen
              </p>
              <p style="margin-top: 5px; font-size: 14px; color: #999">
                oder ziehen Sie eine Datei hierher
              </p>
              <p
                id="upload-as-info"
                style="margin-top: 10px; font-size: 12px; color: #666"
              ></p>
            </div>
            <input type="file" id="file-input" />
            <div class="file-info" id="file-info"></div>
          </label>
          <button type="submit" class="btn-upload" id="upload-btn" disabled>
            Hochladen
          </button>
        </form>
      </div>

      <div class="files-section">
        <h2>üìÇ Geteilte Dateien</h2>
        <div id="file-list" class="file-list">
          <div class="empty-state">Lade Dateien...</div>
        </div>
      </div>
    </div>

    <script>
      let selectedFile = null;
      let currentUser = null;

      const fileInput = document.getElementById("file-input");
      const fileInfo = document.getElementById("file-info");
      const uploadBtn = document.getElementById("upload-btn");
      const uploadForm = document.getElementById("upload-form");
      const messageContainer = document.getElementById("message-container");

      // Check login status
      async function checkLoginStatus() {
        try {
          const response = await fetch("/api/whoami");
          const data = await response.json();
          currentUser = data;

          const userStatus = document.getElementById("user-status");
          const loginLink = document.getElementById("login-link");
          const uploadAsInfo = document.getElementById("upload-as-info");

          if (data.loggedIn) {
            userStatus.textContent = `üë§ ${data.userId}`;
            loginLink.textContent = "üö™ Abmelden";
            loginLink.href = "/";
            uploadAsInfo.textContent = `Hochladen als: ${data.userId}`;
          } else {
            userStatus.textContent = "Anonym";
            loginLink.textContent = "üîê Login";
            loginLink.href = "/";
            uploadAsInfo.textContent =
              "Hochladen als: anonymous (Login f√ºr Namensanzeige)";
          }
        } catch (error) {
          console.error("Error checking login status:", error);
        }
      }

      fileInput.addEventListener("change", (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
          const size = (selectedFile.size / 1024 / 1024).toFixed(2);
          fileInfo.textContent = `Ausgew√§hlt: ${selectedFile.name} (${size} MB)`;
          uploadBtn.disabled = false;
        } else {
          fileInfo.textContent = "";
          uploadBtn.disabled = true;
        }
      });

      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("file", selectedFile);

        uploadBtn.disabled = true;
        uploadBtn.textContent = "Wird hochgeladen...";

        try {
          const response = await fetch("/api/files/upload", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            showMessage("Datei erfolgreich hochgeladen!", "success");
            fileInput.value = "";
            selectedFile = null;
            fileInfo.textContent = "";
            uploadBtn.textContent = "Hochladen";
            loadFiles();
          } else {
            const error = await response.text();
            showMessage("Fehler beim Hochladen: " + error, "error");
            uploadBtn.disabled = false;
            uploadBtn.textContent = "Hochladen";
          }
        } catch (error) {
          showMessage("Fehler: " + error.message, "error");
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Hochladen";
        }
      });

      function showMessage(text, type) {
        messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
        setTimeout(() => {
          messageContainer.innerHTML = "";
        }, 5000);
      }

      async function loadFiles() {
        try {
          const response = await fetch("/api/files/list");

          if (!response.ok) {
            throw new Error("Fehler beim Laden der Dateien");
          }

          const files = await response.json();
          displayFiles(files);
        } catch (error) {
          console.error("Error loading files:", error);
          document.getElementById("file-list").innerHTML =
            '<div class="empty-state">Fehler beim Laden der Dateien</div>';
        }
      }

      function displayFiles(files) {
        const fileList = document.getElementById("file-list");

        if (files.length === 0) {
          fileList.innerHTML =
            '<div class="empty-state">Keine Dateien vorhanden</div>';
          return;
        }

        fileList.innerHTML = files
          .map((file) => {
            const date = new Date(file.uploadedAt);
            const size = (file.size / 1024 / 1024).toFixed(2);
            return `
            <div class="file-item">
              <div class="file-info-text">
                <div class="file-name">üìÑ ${file.name}</div>
                <div class="file-meta">
                  ${size} MB ‚Ä¢ Hochgeladen von ${
              file.uploadedBy
            } ‚Ä¢ ${date.toLocaleDateString("de-DE")} ${date.toLocaleTimeString(
              "de-DE"
            )}
                </div>
              </div>
              <div class="file-actions">
                <button class="btn-download" onclick="downloadFile('${
                  file.name
                }')">
                  ‚¨áÔ∏è Download
                </button>
                <button class="btn-delete" onclick="deleteFile('${file.name}')">
                  üóëÔ∏è L√∂schen
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      async function downloadFile(filename) {
        window.location.href = `/api/files/download/${encodeURIComponent(
          filename
        )}`;
      }

      async function deleteFile(filename) {
        if (!confirm(`M√∂chten Sie "${filename}" wirklich l√∂schen?`)) {
          return;
        }

        try {
          const response = await fetch(
            `/api/files/delete/${encodeURIComponent(filename)}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            showMessage("Datei gel√∂scht", "success");
            loadFiles();
          } else {
            const error = await response.text();
            showMessage("Fehler beim L√∂schen: " + error, "error");
          }
        } catch (error) {
          showMessage("Fehler: " + error.message, "error");
        }
      }

      // Drag and drop
      const wrapper = document.querySelector(".file-input-wrapper");

      wrapper.addEventListener("dragover", (e) => {
        e.preventDefault();
        wrapper.style.borderColor = "#764ba2";
        wrapper.style.background = "#f0f1ff";
      });

      wrapper.addEventListener("dragleave", () => {
        wrapper.style.borderColor = "#667eea";
        wrapper.style.background = "#f8f9ff";
      });

      wrapper.addEventListener("drop", (e) => {
        e.preventDefault();
        wrapper.style.borderColor = "#667eea";
        wrapper.style.background = "#f8f9ff";

        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          selectedFile = e.dataTransfer.files[0];
          const size = (selectedFile.size / 1024 / 1024).toFixed(2);
          fileInfo.textContent = `Ausgew√§hlt: ${selectedFile.name} (${size} MB)`;
          uploadBtn.disabled = false;
        }
      });

      // Load files and check login status on page load
      checkLoginStatus();
      loadFiles();

      // Refresh file list every 10 seconds
      setInterval(loadFiles, 10000);
    </script>
  </body>
</html>
