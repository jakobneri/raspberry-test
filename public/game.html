<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Pi Runner - Mini Game</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .game-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 800px;
        width: 100%;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      h1 {
        color: #333;
        font-size: 24px;
      }
      .score-display {
        font-size: 20px;
        font-weight: bold;
        color: #667eea;
      }
      #gameCanvas {
        width: 100%;
        border: 3px solid #667eea;
        border-radius: 8px;
        background: #f5f5f5;
        display: block;
        cursor: pointer;
      }
      .controls {
        text-align: center;
        margin-top: 15px;
        color: #666;
        font-size: 14px;
      }
      .game-over-screen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .game-over-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        max-width: 500px;
        width: 90%;
      }
      .game-over-content h2 {
        color: #f5576c;
        font-size: 36px;
        margin-bottom: 20px;
      }
      .final-score {
        font-size: 48px;
        font-weight: bold;
        color: #667eea;
        margin: 20px 0;
      }
      .scoreboard {
        margin: 20px 0;
        text-align: left;
      }
      .scoreboard h3 {
        color: #333;
        margin-bottom: 10px;
        text-align: center;
      }
      .score-list {
        list-style: none;
        padding: 0;
      }
      .score-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }
      .score-item:first-child {
        background: #fff9e6;
        font-weight: bold;
      }
      .score-rank {
        color: #999;
        min-width: 30px;
      }
      .score-value {
        font-weight: bold;
        color: #667eea;
      }
      .buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      button,
      .btn {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-primary:hover {
        background: #5568d3;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn-secondary:hover {
        background: #5a6268;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div class="header">
        <h1>ü•ß Pi Runner</h1>
        <div class="score-display">Score: <span id="currentScore">0</span></div>
      </div>
      <canvas id="gameCanvas" width="760" height="200"></canvas>
      <div class="controls">Press SPACE or click to jump! üöÄ</div>
    </div>

    <div class="game-over-screen" id="gameOverScreen">
      <div class="game-over-content">
        <h2>Game Over!</h2>
        <div class="final-score" id="finalScore">0</div>

        <div class="scoreboard" id="scoreboard">
          <h3>üèÜ Top 5 Scores</h3>
          <ul class="score-list" id="scoreList"></ul>
        </div>

        <div class="buttons">
          <button class="btn btn-primary" onclick="restartGame()">
            Play Again
          </button>
          <a href="/cockpit" class="btn btn-secondary">Cockpit</a>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      let gameRunning = false;
      let score = 0;
      let gameSpeed = 6;
      let gravity = 0.6;
      let difficultyMultiplier = 1;

      // Player (Raspberry Pi)
      const player = {
        x: 50,
        y: 150,
        width: 40,
        height: 40,
        dy: 0,
        jumpPower: -12,
        grounded: false,
        emoji: "ü•ß",
      };

      // Obstacles
      let obstacles = [];
      let obstacleTimer = 0;
      let obstacleInterval = 90;
      let minObstacleInterval = 40;
      let maxObstacleInterval = 100;

      // Background elements
      let clouds = [];
      let groundOffset = 0;

      // Initialize clouds
      for (let i = 0; i < 3; i++) {
        clouds.push({
          x: Math.random() * canvas.width,
          y: Math.random() * 50,
          speed: 0.5 + Math.random() * 0.5,
        });
      }

      function jump() {
        if (player.grounded && gameRunning) {
          player.dy = player.jumpPower;
          player.grounded = false;
        }
      }

      function startGame() {
        gameRunning = true;
        score = 0;
        gameSpeed = 6;
        difficultyMultiplier = 1;
        obstacles = [];
        obstacleTimer = 0;
        obstacleInterval = 90;
        player.y = 150;
        player.dy = 0;
        player.grounded = false;
        document.getElementById("currentScore").textContent = "0";
        gameLoop();
      }

      function restartGame() {
        document.getElementById("gameOverScreen").style.display = "none";
        startGame();
      }

      async function endGame() {
        gameRunning = false;
        document.getElementById("finalScore").textContent = score;

        // Save score
        try {
          await fetch("/api/scores", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ score }),
          });

          // Load scoreboard
          const response = await fetch("/api/scores");
          const scores = await response.json();
          displayScoreboard(scores);
        } catch (error) {
          console.error("Error saving score:", error);
        }

        document.getElementById("gameOverScreen").style.display = "flex";
      }

      function displayScoreboard(scores) {
        const scoreList = document.getElementById("scoreList");
        scoreList.innerHTML = "";

        scores.slice(0, 5).forEach((s, index) => {
          const li = document.createElement("li");
          li.className = "score-item";
          li.innerHTML = `
            <span class="score-rank">#${index + 1}</span>
            <span class="score-value">${s.score}</span>
            <span>${new Date(s.timestamp).toLocaleDateString("de-DE")}</span>
          `;
          scoreList.appendChild(li);
        });
      }

      function updatePlayer() {
        // Apply gravity
        player.dy += gravity;
        player.y += player.dy;

        // Ground collision
        const groundY = canvas.height - player.height - 10;
        if (player.y >= groundY) {
          player.y = groundY;
          player.dy = 0;
          player.grounded = true;
        }
      }

      function updateObstacles() {
        obstacleTimer++;

        if (obstacleTimer > obstacleInterval) {
          // Random obstacle types with varying sizes
          const obstacleTypes = [
            { emoji: "üåµ", width: 20, height: 45 },
            { emoji: "ü™®", width: 25, height: 35 },
            { emoji: "üå≥", width: 30, height: 50 },
            { emoji: "üî•", width: 20, height: 40 },
            { emoji: "üå¥", width: 25, height: 48 },
            { emoji: "‚ö°", width: 18, height: 38 },
          ];

          const type =
            obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];

          obstacles.push({
            x: canvas.width,
            y: canvas.height - 50,
            width: type.width,
            height: type.height,
            emoji: type.emoji,
          });
          obstacleTimer = 0;

          // More aggressive spacing reduction
          obstacleInterval =
            minObstacleInterval +
            Math.random() * (maxObstacleInterval - minObstacleInterval);
        }

        // Move and remove obstacles
        obstacles = obstacles.filter((obstacle) => {
          obstacle.x -= gameSpeed;
          return obstacle.x + obstacle.width > 0;
        });
      }

      function checkCollision() {
        for (let obstacle of obstacles) {
          if (
            player.x < obstacle.x + obstacle.width &&
            player.x + player.width > obstacle.x &&
            player.y < obstacle.y + obstacle.height &&
            player.y + player.height > obstacle.y
          ) {
            endGame();
            return true;
          }
        }
        return false;
      }

      function updateScore() {
        score++;
        document.getElementById("currentScore").textContent = score;

        // More aggressive difficulty increase
        if (score % 200 === 0) {
          gameSpeed += 0.8;
          difficultyMultiplier += 0.1;

          // Reduce obstacle spacing over time
          maxObstacleInterval = Math.max(60, maxObstacleInterval - 5);
          minObstacleInterval = Math.max(30, minObstacleInterval - 2);
        }
      }

      function drawBackground() {
        // Sky
        ctx.fillStyle = "#87CEEB";
        ctx.fillRect(0, 0, canvas.width, canvas.height - 50);

        // Clouds
        ctx.font = "20px Arial";
        clouds.forEach((cloud) => {
          ctx.fillText("‚òÅÔ∏è", cloud.x, cloud.y + 20);
          cloud.x -= cloud.speed;
          if (cloud.x < -30) {
            cloud.x = canvas.width;
            cloud.y = Math.random() * 50;
          }
        });

        // Ground
        ctx.fillStyle = "#8B7355";
        ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

        // Ground pattern
        ctx.fillStyle = "#6B5345";
        groundOffset -= gameSpeed;
        if (groundOffset < -20) groundOffset = 0;
        for (let i = groundOffset; i < canvas.width; i += 20) {
          ctx.fillRect(i, canvas.height - 45, 15, 5);
        }
      }

      function drawPlayer() {
        ctx.font = "40px Arial";
        ctx.fillText(player.emoji, player.x, player.y + player.height);
      }

      function drawObstacles() {
        ctx.font = "40px Arial";
        obstacles.forEach((obstacle) => {
          ctx.fillText(
            obstacle.emoji,
            obstacle.x,
            obstacle.y + obstacle.height
          );
        });
      }

      function gameLoop() {
        if (!gameRunning) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawBackground();
        updatePlayer();
        updateObstacles();
        drawPlayer();
        drawObstacles();

        if (!checkCollision()) {
          updateScore();
        }

        requestAnimationFrame(gameLoop);
      }

      // Event listeners
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          if (!gameRunning) {
            startGame();
          } else {
            jump();
          }
        }
      });

      canvas.addEventListener("click", () => {
        if (!gameRunning) {
          startGame();
        } else {
          jump();
        }
      });

      // Draw initial state
      drawBackground();
      drawPlayer();
      ctx.fillStyle = "#333";
      ctx.font = "24px Arial";
      ctx.textAlign = "center";
      ctx.fillText("Click or press SPACE to start!", canvas.width / 2, 100);
    </script>
  </body>
</html>
