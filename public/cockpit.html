<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Raspberry Pi Cockpit</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/cockpit.css" />
  </head>
  <body>
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>ü•ß Pi Cockpit</h1>
        <div class="subtitle">Raspberry Pi Server</div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Admin Pages</div>
          <a href="/cockpit" class="nav-link active">
            <span class="nav-link-icon">üìä</span>
            <span>Dashboard</span>
          </a>
          <a href="/users" class="nav-link">
            <span class="nav-link-icon">üë•</span>
            <span>User Management</span>
          </a>
          <a href="/game-admin" class="nav-link">
            <span class="nav-link-icon">‚öôÔ∏è</span>
            <span>Game Admin</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Public Pages</div>
          <a href="/files" class="nav-link">
            <span class="nav-link-icon">üìÅ</span>
            <span>Files</span>
          </a>
          <a href="/game" class="nav-link">
            <span class="nav-link-icon">üéÆ</span>
            <span>Game</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container">
        <div id="error-message" style="display: none" class="error"></div>
        <div id="loading" class="loading">Lade Metriken...</div>

        <div id="metrics" style="display: none">
          <div class="metrics-grid">
            <!-- CPU Card -->
            <div class="metric-card">
              <div class="metric-header">
                <div class="metric-icon">üñ•Ô∏è</div>
                <div class="metric-title">CPU Auslastung</div>
              </div>
              <div class="metric-value" id="cpu-usage">--</div>
              <div class="metric-detail">
                Kerne: <span id="cpu-cores">--</span>
              </div>
              <div class="metric-detail">
                Takt: <span id="cpu-speed">--</span> GHz
              </div>
              <div class="metric-detail">
                Temperatur: <span id="cpu-temp">--</span>¬∞C
              </div>
              <div class="chart-container">
                <canvas id="cpu-chart"></canvas>
              </div>
            </div>

            <!-- Memory Card -->
            <div class="metric-card">
              <div class="metric-header">
                <div class="metric-icon">üíæ</div>
                <div class="metric-title">RAM Speicher</div>
              </div>
              <div class="metric-value" id="mem-usage">--</div>
              <div class="metric-detail">
                Verwendet: <span id="mem-used">--</span> GB
              </div>
              <div class="metric-detail">
                Frei: <span id="mem-free">--</span> GB
              </div>
              <div class="metric-detail">
                Gesamt: <span id="mem-total">--</span> GB
              </div>
              <div class="chart-container">
                <canvas id="mem-chart"></canvas>
              </div>
            </div>

            <!-- Disk Card -->
            <div class="metric-card">
              <div class="metric-header">
                <div class="metric-icon">üíø</div>
                <div class="metric-title">Festplatte</div>
              </div>
              <div class="metric-value" id="disk-usage">--</div>
              <div class="metric-detail">
                Verwendet: <span id="disk-used">--</span> GB
              </div>
              <div class="metric-detail">
                Verf√ºgbar: <span id="disk-available">--</span> GB
              </div>
              <div class="metric-detail">
                I/O: R:<span id="disk-rio">--</span> W:<span id="disk-wio"
                  >--</span
                >
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="disk-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <!-- Network Card -->
            <div
              class="metric-card"
              style="cursor: pointer"
              onclick="openNetworkModal()"
            >
              <div class="metric-header">
                <div class="metric-icon">üåê</div>
                <div class="metric-title">Netzwerk</div>
              </div>
              <div class="metric-value" id="net-down">-- KB/s</div>
              <div class="metric-detail">
                Download: <span id="net-rx">--</span> KB/s
              </div>
              <div class="metric-detail">
                Upload: <span id="net-tx">--</span> KB/s
              </div>
              <div class="metric-detail">
                Interface: <span id="net-interface">--</span>
              </div>
              <div class="chart-container">
                <canvas id="net-chart"></canvas>
              </div>
            </div>

            <!-- System Load Card -->
            <div class="metric-card">
              <div class="metric-header">
                <div class="metric-icon">‚öôÔ∏è</div>
                <div class="metric-title">System Load</div>
              </div>
              <div class="metric-value" id="sys-load">--</div>
              <div class="metric-detail">
                Prozesse: <span id="sys-procs">--</span>
              </div>
              <div class="metric-detail">
                Laufend: <span id="sys-procs-run">--</span>
              </div>
              <div class="metric-detail">
                Blockiert: <span id="sys-procs-block">--</span>
              </div>
              <div class="chart-container">
                <canvas id="sys-chart"></canvas>
              </div>
            </div>

            <!-- System Info Card -->
            <div class="metric-card">
              <div class="metric-header">
                <div class="metric-icon">‚ÑπÔ∏è</div>
                <div class="metric-title">System Info</div>
              </div>
              <div
                style="
                  text-align: center;
                  margin-bottom: 5px;
                  color: var(--text-secondary);
                  font-size: 0.9rem;
                "
              >
                Uptime
              </div>
              <div
                class="metric-value"
                id="sys-uptime"
                style="font-size: 1.8rem; margin-bottom: 20px; color: #667eea"
              >
                --
              </div>

              <div
                class="system-info-list"
                style="
                  display: flex;
                  flex-direction: column;
                  gap: 12px;
                  padding: 0 10px;
                "
              >
                <div
                  class="info-item"
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    border-bottom: 1px solid var(--border-color);
                    padding-bottom: 8px;
                  "
                >
                  <span
                    style="
                      color: var(--text-secondary);
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    "
                    ><span style="font-size: 1.2em">üñ•Ô∏è</span> Host</span
                  >
                  <span
                    id="sys-host"
                    style="font-weight: 600; color: var(--text-primary)"
                    >--</span
                  >
                </div>

                <div
                  class="info-item"
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    border-bottom: 1px solid var(--border-color);
                    padding-bottom: 8px;
                  "
                >
                  <span
                    style="
                      color: var(--text-secondary);
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    "
                    ><span style="font-size: 1.2em">üêß</span> OS</span
                  >
                  <span
                    id="sys-os"
                    style="font-weight: 600; color: var(--text-primary)"
                    >--</span
                  >
                </div>

                <div
                  class="info-item"
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    border-bottom: 1px solid var(--border-color);
                    padding-bottom: 8px;
                  "
                >
                  <span
                    style="
                      color: var(--text-secondary);
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    "
                    ><span style="font-size: 1.2em">‚öôÔ∏è</span> Kernel</span
                  >
                  <span
                    id="sys-kernel"
                    style="font-weight: 600; color: var(--text-primary)"
                    >--</span
                  >
                </div>

                <div
                  class="info-item"
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding-bottom: 8px;
                  "
                >
                  <span
                    style="
                      color: var(--text-secondary);
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    "
                    ><span style="font-size: 1.2em">üì¶</span> Distro</span
                  >
                  <span
                    id="sys-distro"
                    style="font-weight: 600; color: var(--text-primary)"
                    >--</span
                  >
                </div>
              </div>

              <div
                class="admin-buttons"
                style="
                  margin-top: 15px;
                  padding-top: 15px;
                  border-top: 1px solid #eee;
                  display: flex;
                  gap: 10px;
                  justify-content: center;
                "
              >
                <button
                  class="btn-admin btn-restart"
                  onclick="restartServer()"
                  style="flex: 1"
                >
                  üîÑ Neustart
                </button>
                <button
                  class="btn-admin btn-shutdown"
                  onclick="shutdownServer()"
                  style="flex: 1"
                >
                  ‚õî Beenden
                </button>
              </div>
            </div>

            <!-- Sessions Card -->
            <div
              class="metric-card"
              onclick="openSessionsModal()"
              style="cursor: pointer"
            >
              <div class="metric-header">
                <div class="metric-icon">üë•</div>
                <div class="metric-title">Sessions</div>
              </div>
              <div class="metric-value" id="session-count-card">--</div>
              <div class="metric-detail">
                Active Users: <span id="session-active-users">--</span>
              </div>
              <div
                class="metric-detail"
                style="
                  font-size: 0.8em;
                  color: var(--text-secondary);
                  margin-top: 10px;
                "
              >
                Click for details
              </div>
            </div>

            <!-- Terminal Card -->
            <div class="metric-card" style="grid-column: span 2">
              <div class="metric-header" style="justify-content: space-between">
                <div style="display: flex; align-items: center; gap: 10px">
                  <div class="metric-icon">üñ•Ô∏è</div>
                  <div class="metric-title">Server Terminal</div>
                </div>
                <div style="display: flex; gap: 10px">
                  <select
                    id="log-level"
                    onchange="setLogLevel(this.value)"
                    style="
                      padding: 2px 5px;
                      border-radius: 4px;
                      background: var(--bg-color);
                      color: var(--text-color);
                      border: 1px solid var(--border-color);
                      font-size: 0.8rem;
                    "
                  >
                    <option value="info">Info</option>
                    <option value="warn">Warn</option>
                    <option value="error">Error</option>
                  </select>
                  <button
                    onclick="clearTerminal()"
                    style="
                      padding: 2px 8px;
                      border-radius: 4px;
                      background: var(--bg-color);
                      color: var(--text-color);
                      border: 1px solid var(--border-color);
                      cursor: pointer;
                      font-size: 0.8rem;
                    "
                  >
                    Clear
                  </button>
                </div>
              </div>
              <div
                id="terminal-output"
                style="
                  background: #1e1e1e;
                  color: #d4d4d4;
                  padding: 10px;
                  border-radius: 4px;
                  height: 200px;
                  overflow-y: auto;
                  font-family: monospace;
                  font-size: 12px;
                  white-space: pre-wrap;
                  margin-top: 10px;
                "
              ></div>
            </div>
          </div>

          <div class="timestamp">
            Letzte Aktualisierung: <span id="last-update">--</span>
          </div>
        </div>
      </div>

      <!-- Sessions Modal -->
      <div id="sessions-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>üìä Aktive Sessions</h2>
            <span class="close" onclick="closeSessionsModal()">&times;</span>
          </div>
          <div id="sessions-list"></div>
        </div>
      </div>

      <!-- Network Modal -->
      <div id="wifi-modal" class="modal">
        <div class="modal-content" style="max-width: 900px">
          <div class="modal-header">
            <h2>üåê Network Management</h2>
            <span class="close" onclick="closeWifiModal()">&times;</span>
          </div>
          <div style="padding: 20px">
            <!-- Network Details Section -->
            <div style="margin-bottom: 25px">
              <h3 style="color: #667eea; margin-bottom: 15px">
                üìä Network Details
              </h3>
              <div
                id="network-details"
                style="
                  background: var(--bg-color);
                  padding: 15px;
                  border-radius: 8px;
                  font-size: 14px;
                  line-height: 1.8;
                  border: 1px solid var(--border-color);
                "
              >
                <p style="text-align: center; color: var(--text-secondary)">
                  Loading network information...
                </p>
              </div>
            </div>

            <!-- Speedtest Section -->
            <div style="margin-bottom: 25px">
              <h3 style="color: #667eea; margin-bottom: 15px">üöÄ Speed Test</h3>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  margin-bottom: 10px;
                  flex-wrap: wrap;
                "
              >
                <button
                  class="btn-admin"
                  onclick="runSpeedtest()"
                  id="speedtest-btn"
                  style="flex: 0 0 auto"
                >
                  ‚ñ∂Ô∏è Run Speed Test
                </button>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin: 0 10px;
                  "
                >
                  <input
                    type="checkbox"
                    id="auto-speedtest-toggle"
                    onchange="toggleAutoSpeedtest(this.checked)"
                  />
                  <label
                    for="auto-speedtest-toggle"
                    style="
                      font-size: 14px;
                      cursor: pointer;
                      color: var(--text-primary);
                    "
                    >Auto Run</label
                  >
                </div>
                <select
                  id="speedtest-interval"
                  onchange="setSpeedtestInterval()"
                  style="
                    padding: 8px 12px;
                    border-radius: 6px;
                    border: 2px solid #667eea;
                    font-size: 14px;
                    cursor: pointer;
                    background: var(--card-bg);
                    color: var(--text-primary);
                  "
                >
                  <option value="10">Every 10 seconds</option>
                  <option value="30">Every 30 seconds</option>
                  <option value="60" selected>Every 1 minute</option>
                  <option value="300">Every 5 minutes</option>
                  <option value="600">Every 10 minutes</option>
                </select>
                <div
                  id="speedtest-warning"
                  style="font-size: 12px; color: var(--text-secondary); flex: 1"
                >
                  Auto-running speed tests
                </div>
              </div>

              <!-- Speedtest Graphs -->
              <div
                style="
                  background: var(--bg-color);
                  padding: 20px;
                  border-radius: 8px;
                  margin-bottom: 15px;
                  border: 1px solid var(--border-color);
                "
              >
                <div
                  style="
                    display: flex;
                    gap: 10px;
                    margin-bottom: 15px;
                    justify-content: center;
                  "
                >
                  <button
                    class="btn-admin"
                    onclick="focusSpeedtestMetric('all')"
                    id="focus-all"
                    style="background: #667eea"
                  >
                    All Metrics
                  </button>
                  <button
                    class="btn-admin"
                    onclick="focusSpeedtestMetric('ping')"
                    id="focus-ping"
                  >
                    Ping
                  </button>
                  <button
                    class="btn-admin"
                    onclick="focusSpeedtestMetric('download')"
                    id="focus-download"
                  >
                    Download
                  </button>
                  <button
                    class="btn-admin"
                    onclick="focusSpeedtestMetric('upload')"
                    id="focus-upload"
                  >
                    Upload
                  </button>
                </div>
                <canvas id="speedtest-chart" style="max-height: 300px"></canvas>
              </div>

              <div
                id="speedtest-results"
                style="
                  background: var(--bg-color);
                  padding: 15px;
                  border-radius: 8px;
                  font-size: 14px;
                  border: 1px solid var(--border-color);
                "
              >
                <p style="text-align: center; color: var(--text-secondary)">
                  Loading speed test data...
                </p>
              </div>
            </div>

            <!-- WiFi Management Section -->
            <div>
              <h3 style="color: #667eea; margin-bottom: 15px">
                üì° WiFi Management
              </h3>
              <button class="btn-admin" onclick="scanWifi()" id="scan-btn">
                üîÑ Scan Networks
              </button>
              <div
                id="wifi-status"
                style="
                  margin: 15px 0;
                  padding: 10px;
                  background: var(--card-bg);
                  border-radius: 6px;
                  font-size: 14px;
                  border: 1px solid var(--border-color);
                  color: var(--text-primary);
                "
              ></div>
              <div id="wifi-list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Modal -->
      <div id="logs-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px">
          <div class="modal-header">
            <h2>üìã Server Logs</h2>
            <span class="close" onclick="closeLogsModal()">&times;</span>
          </div>
          <div style="padding: 20px">
            <div style="margin-bottom: 15px; display: flex; gap: 10px">
              <button class="btn-admin" onclick="refreshLogs()">
                üîÑ Refresh
              </button>
              <button
                class="btn-admin"
                onclick="clearServerLogs()"
                style="background: #dc3545"
              >
                üóëÔ∏è Clear Logs
              </button>
              <label
                style="
                  margin-left: auto;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <input type="checkbox" id="auto-scroll-logs" checked />
                Auto-scroll
              </label>
            </div>
            <div
              id="logs-container"
              style="
                background: #1e1e1e;
                color: #d4d4d4;
                padding: 15px;
                border-radius: 8px;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                height: 500px;
                overflow-y: auto;
                line-height: 1.6;
              "
            >
              <div style="text-align: center; color: var(--text-secondary)">
                Loading logs...
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        let updateInterval;
        let cpuChart, memChart, netChart, sysChart, speedtestChart;
        let speedtestFocusMode = "all";
        let currentSessionCount = 0;

        async function fetchMetrics() {
          try {
            const response = await fetch("/api/metrics");

            if (!response.ok) {
              if (response.status === 401) {
                window.location.href = "/";
                return;
              }
              throw new Error("Fehler beim Laden der Metriken");
            }

            const data = await response.json();
            updateUI(data.current, data.history);

            document.getElementById("loading").style.display = "none";
            document.getElementById("metrics").style.display = "block";
            document.getElementById("error-message").style.display = "none";
          } catch (error) {
            console.error("Error:", error);
            document.getElementById("error-message").textContent =
              "Fehler beim Laden der Metriken: " + error.message;
            document.getElementById("error-message").style.display = "block";
          }
        }

        function updateUI(data, history) {
          // CPU
          document.getElementById("cpu-usage").textContent =
            data.cpu.usage.toFixed(1) + "%";
          document.getElementById("cpu-cores").textContent = data.cpu.cores;
          document.getElementById("cpu-speed").textContent = data.cpu.speed;
          document.getElementById("cpu-temp").textContent =
            data.cpu.temperature.toFixed(1);

          // Memory
          document.getElementById("mem-usage").textContent =
            data.memory.usagePercent.toFixed(1) + "%";
          document.getElementById("mem-used").textContent =
            data.memory.used.toFixed(2);
          document.getElementById("mem-free").textContent =
            data.memory.free.toFixed(2);
          document.getElementById("mem-total").textContent =
            data.memory.total.toFixed(2);

          // Disk
          document.getElementById("disk-usage").textContent =
            data.disk.usagePercent.toFixed(1) + "%";
          document.getElementById("disk-used").textContent =
            data.disk.used.toFixed(2);
          document.getElementById("disk-available").textContent =
            data.disk.available.toFixed(2);
          document.getElementById("disk-rio").textContent = data.disk.rIO;
          document.getElementById("disk-wio").textContent = data.disk.wIO;
          updateProgressBar("disk-progress", data.disk.usagePercent);

          // Network
          document.getElementById("net-down").textContent =
            data.network.rx.toFixed(2) + " KB/s";
          document.getElementById("net-rx").textContent =
            data.network.rx.toFixed(2);
          document.getElementById("net-tx").textContent =
            data.network.tx.toFixed(2);
          document.getElementById("net-interface").textContent =
            data.network.interface;

          // System Load
          if (data.system) {
            document.getElementById("sys-load").textContent =
              data.system.loadAvg[0].toFixed(2);
            document.getElementById("sys-procs").textContent =
              data.system.processCount;
            document.getElementById("sys-procs-run").textContent =
              data.system.processRunning;
            document.getElementById("sys-procs-block").textContent =
              data.system.processBlocked;
          }

          // System Info
          if (data.os && data.system) {
            const uptimeHours = Math.floor(data.system.uptime / 3600);
            const uptimeMins = Math.floor((data.system.uptime % 3600) / 60);
            document.getElementById(
              "sys-uptime"
            ).textContent = `${uptimeHours}h ${uptimeMins}m`;
            document.getElementById("sys-host").textContent = data.os.hostname;
            document.getElementById("sys-os").textContent = data.os.platform;
            document.getElementById("sys-kernel").textContent = data.os.release;
            document.getElementById("sys-distro").textContent = data.os.distro;
          }

          // Timestamp
          const date = new Date(data.timestamp);
          document.getElementById("last-update").textContent =
            date.toLocaleTimeString("de-DE");

          // Update charts
          if (history && history.length > 0) {
            updateCharts(history);
          }
        }

        function updateProgressBar(id, percent) {
          const bar = document.getElementById(id);
          if (bar) {
            bar.style.width = percent + "%";

            // Add warning class if usage is high
            if (percent > 80) {
              bar.classList.add("warning");
            } else {
              bar.classList.remove("warning");
            }
          }
        }

        function initCharts() {
          const chartConfig = (label, color) => ({
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: label,
                  data: [],
                  borderColor: color,
                  backgroundColor: color + "20",
                  tension: 0.4,
                  fill: true,
                  pointRadius: 0,
                  pointHoverRadius: 6,
                  pointHitRadius: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  mode: "index",
                  intersect: false,
                  callbacks: {
                    title: function (context) {
                      return "Sample " + (context[0].dataIndex + 1);
                    },
                    label: function (context) {
                      return (
                        context.dataset.label +
                        ": " +
                        context.parsed.y.toFixed(1)
                      );
                    },
                  },
                },
              },
              interaction: {
                mode: "nearest",
                axis: "x",
                intersect: false,
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                },
                x: {
                  display: false,
                },
              },
            },
          });

          cpuChart = new Chart(
            document.getElementById("cpu-chart"),
            chartConfig("CPU %", "#667eea")
          );
          memChart = new Chart(
            document.getElementById("mem-chart"),
            chartConfig("RAM %", "#764ba2")
          );
          const netConfig = chartConfig("Network KB/s", "#4facfe");
          netConfig.options.scales.y.max = null; // Network has different scale
          netChart = new Chart(document.getElementById("net-chart"), netConfig);

          const sysConfig = chartConfig("Load Avg", "#ff9f43");
          sysConfig.options.scales.y.max = null; // Load can be anything
          sysChart = new Chart(document.getElementById("sys-chart"), sysConfig);
        }

        function updateCharts(history) {
          if (!cpuChart) {
            initCharts();
          }

          const labels = history.map((_, i) => i);

          // CPU Chart
          cpuChart.data.labels = labels;
          cpuChart.data.datasets[0].data = history.map((h) => h.cpu.usage);
          cpuChart.update("none");

          // Memory Chart
          memChart.data.labels = labels;
          memChart.data.datasets[0].data = history.map(
            (h) => h.memory.usagePercent
          );
          memChart.update("none");

          // Network Chart (combined RX + TX)
          netChart.data.labels = labels;
          netChart.data.datasets[0].data = history.map(
            (h) => h.network.rx + h.network.tx
          );
          netChart.update("none");

          // System Load Chart
          sysChart.data.labels = labels;
          sysChart.data.datasets[0].data = history.map((h) =>
            h.system ? h.system.loadAvg[0] : 0
          );
          sysChart.update("none");
        }

        async function fetchSessions() {
          try {
            const response = await fetch("/api/sessions");
            if (response.ok) {
              const data = await response.json();
              currentSessionCount = data.sessions.length;

              // Update Button Count
              const countEl = document.getElementById("session-count-btn");
              if (countEl) {
                countEl.textContent = currentSessionCount;
              }

              // Update Card
              const cardCountEl = document.getElementById("session-count-card");
              const activeUsersEl = document.getElementById(
                "session-active-users"
              );

              if (cardCountEl) {
                cardCountEl.textContent = currentSessionCount;
              }

              if (activeUsersEl) {
                const uniqueUsers = new Set(data.sessions.map((s) => s.userId))
                  .size;
                activeUsersEl.textContent = uniqueUsers;
              }

              return data;
            }
          } catch (error) {
            console.error("Error loading sessions:", error);
          }
          return null;
        }

        async function openSessionsModal() {
          const data = await fetchSessions();
          if (!data) return;

          const modal = document.getElementById("sessions-modal");
          const list = document.getElementById("sessions-list");

          let html = "";

          // App Token
          if (data.appToken) {
            const shortToken =
              data.appToken.substring(0, 20) +
              "..." +
              data.appToken.substring(data.appToken.length - 10);
            html += `
            <div class="session-item">
              <h3>üîë Azure App Token</h3>
              <div class="token-display" id="app-token-display">${shortToken}</div>
              <button class="btn-copy" onclick="toggleToken('app-token-display', '${data.appToken}', this)">Show Full</button>
              <button class="btn-copy" onclick="copyToken('${data.appToken}')">Copy</button>
            </div>
          `;
          }

          // Sessions
          data.sessions.forEach((session, index) => {
            const shortToken =
              session.token.substring(0, 20) +
              "..." +
              session.token.substring(session.token.length - 10);
            const created = new Date(session.createdAt).toLocaleString("de-DE");
            const lastActivity = new Date(session.lastActivity).toLocaleString(
              "de-DE"
            );

            html += `
            <div class="session-item">
              <h3>üë§ Session ${index + 1} - User: ${session.userId}</h3>
              <p><strong>Erstellt:</strong> ${created}</p>
              <p><strong>Letzte Aktivit√§t:</strong> ${lastActivity}</p>
              <div class="token-display" id="token-${
                session.id
              }">${shortToken}</div>
              <button class="btn-copy" onclick="toggleToken('token-${
                session.id
              }', '${session.token}', this)">Show Full</button>
              <button class="btn-copy" onclick="copyToken('${
                session.token
              }')">Copy</button>
            </div>
          `;
          });

          list.innerHTML =
            html ||
            '<p style="text-align:center;padding:20px;">Keine aktiven Sessions</p>';
          modal.style.display = "block";
        }

        function closeSessionsModal() {
          document.getElementById("sessions-modal").style.display = "none";
        }

        function toggleToken(elementId, fullToken, button) {
          const element = document.getElementById(elementId);
          if (button.textContent === "Show Full") {
            element.textContent = fullToken;
            button.textContent = "Show Short";
          } else {
            const shortToken =
              fullToken.substring(0, 20) +
              "..." +
              fullToken.substring(fullToken.length - 10);
            element.textContent = shortToken;
            button.textContent = "Show Full";
          }
        }

        function copyToken(token) {
          navigator.clipboard.writeText(token).then(() => {
            alert("Token kopiert!");
          });
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
          const sessionsModal = document.getElementById("sessions-modal");
          const wifiModal = document.getElementById("wifi-modal");
          const logsModal = document.getElementById("logs-modal");
          if (event.target === sessionsModal) {
            closeSessionsModal();
          }
          if (event.target === wifiModal) {
            closeWifiModal();
          }
          if (event.target === logsModal) {
            closeLogsModal();
          }
        };

        async function openNetworkModal() {
          const modal = document.getElementById("wifi-modal");
          modal.style.display = "block";
          await fetchNetworkDetails();
          await fetchWifiStatus();
        }

        function closeWifiModal() {
          document.getElementById("wifi-modal").style.display = "none";
        }

        async function fetchNetworkDetails() {
          try {
            const response = await fetch("/api/network/details");
            if (response.ok) {
              const data = await response.json();
              displayNetworkDetails(data);
            }
          } catch (error) {
            console.error("Error fetching network details:", error);
            document.getElementById("network-details").innerHTML =
              '<p style="color: #f5576c;">Error loading network details</p>';
          }
        }

        function displayNetworkDetails(data) {
          const detailsDiv = document.getElementById("network-details");

          const ethStatus = data.ethernet.connected
            ? '<span style="color: #28a745;">‚úÖ Connected</span>'
            : '<span style="color: var(--text-secondary);">‚ö´ Disconnected</span>';

          const wifiStatus = data.wifi.connected
            ? '<span style="color: #28a745;">‚úÖ Connected</span>'
            : '<span style="color: var(--text-secondary);">‚ö´ Disconnected</span>';

          let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Ethernet Section -->
            <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
              <h4 style="margin: 0 0 15px 0; color: #667eea;">
                üîå Ethernet (eth0)
              </h4>
              <div style="font-size: 14px; line-height: 2; color: var(--text-primary);">
                <div>
                  <strong>Status:</strong> ${ethStatus}
                </div>
                ${
                  data.ethernet.connected
                    ? `
                  <div><strong>IP:</strong> ${data.ethernet.ipAddress}</div>
                  <div><strong>MAC:</strong> ${data.ethernet.macAddress}</div>
                  <div><strong>Speed:</strong> ${data.ethernet.speed}</div>
                  <div><strong>RX:</strong> ${data.ethernet.rx.toFixed(
                    2
                  )} KB/s</div>
                  <div><strong>TX:</strong> ${data.ethernet.tx.toFixed(
                    2
                  )} KB/s</div>
                `
                    : ""
                }
              </div>
            </div>

            <!-- WiFi Section -->
            <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
              <h4 style="margin: 0 0 15px 0; color: #667eea;">
                üì∂ WiFi (wlan0)
              </h4>
              <div style="font-size: 14px; line-height: 2; color: var(--text-primary);">
                <div>
                  <strong>Status:</strong> ${wifiStatus}
                </div>
                ${
                  data.wifi.connected
                    ? `
                  <div><strong>SSID:</strong> ${data.wifi.ssid}</div>
                  ${
                    data.wifi.signal
                      ? `<div><strong>Signal:</strong> ${data.wifi.signal}%</div>`
                      : ""
                  }
                  <div><strong>IP:</strong> ${data.wifi.ipAddress}</div>
                  <div><strong>MAC:</strong> ${data.wifi.macAddress}</div>
                  <div><strong>Speed:</strong> ${data.wifi.speed}</div>
                  <div><strong>RX:</strong> ${data.wifi.rx.toFixed(
                    2
                  )} KB/s</div>
                  <div><strong>TX:</strong> ${data.wifi.tx.toFixed(
                    2
                  )} KB/s</div>
                `
                    : ""
                }
              </div>
            </div>
          </div>
        `;

          detailsDiv.innerHTML = html;
        }

        async function runSpeedtest() {
          const btn = document.getElementById("speedtest-btn");
          const resultsDiv = document.getElementById("speedtest-results");

          btn.disabled = true;
          btn.textContent = "‚è≥ Running Speed Test...";

          // Animated progress bar
          resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <p style="color: #667eea; margin-bottom: 15px; font-weight: 600;">‚è≥ Testing connection speed...</p>
            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
              <div id="speedtest-progress" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
            </div>
            <p style="font-size: 12px; color: var(--text-secondary);">This may take up to 60 seconds</p>
          </div>
        `;

          // Animate progress bar
          let progress = 0;
          const progressBar = document.getElementById("speedtest-progress");
          const progressInterval = setInterval(() => {
            progress += 1.5;
            if (progress > 95) progress = 95;
            progressBar.style.width = progress + "%";
          }, 500);

          try {
            const response = await fetch("/api/speedtest", {
              method: "POST",
            });

            clearInterval(progressInterval);

            // Smoothly complete the progress bar
            progressBar.style.width = "100%";

            // Wait for animation to complete
            await new Promise((resolve) => setTimeout(resolve, 500));

            if (response.ok) {
              const data = await response.json();

              if (data.success) {
                let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                  <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">PING</div>
                    <div style="font-size: 36px; font-weight: bold; color: #667eea;">${data.ping}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">ms</div>
                  </div>
              `;

                if (data.download !== null) {
                  html += `
                  <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">DOWNLOAD</div>
                    <div style="font-size: 36px; font-weight: bold; color: #28a745;">${data.download}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">${data.unit}</div>
                  </div>
                `;
                }

                if (data.upload !== null) {
                  html += `
                  <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">UPLOAD</div>
                    <div style="font-size: 36px; font-weight: bold; color: #f5576c;">${data.upload}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">${data.unit}</div>
                  </div>
                `;
                }

                html += `</div>`;

                if (data.message) {
                  html += `<p style="margin-top: 15px; font-size: 12px; color: var(--text-secondary); text-align: center;">${data.message}</p>`;
                }

                html += `<p style="margin-top: 10px; font-size: 11px; color: var(--text-secondary); text-align: center;">Tested at: ${new Date(
                  data.timestamp
                ).toLocaleString()}</p>`;

                resultsDiv.innerHTML = html;
              } else {
                resultsDiv.innerHTML = `<p style="color: #f5576c; text-align: center;">${data.message}</p>`;
              }
            }
          } catch (error) {
            console.error("Error running speedtest:", error);
            clearInterval(progressInterval);
            resultsDiv.innerHTML =
              '<p style="color: #f5576c; text-align: center;">Error running speed test</p>';
          } finally {
            btn.disabled = false;
            btn.textContent = "‚ñ∂Ô∏è Run Speed Test";
          }
        }

        async function fetchWifiStatus() {
          try {
            const response = await fetch("/api/wifi/status");
            if (response.ok) {
              const data = await response.json();
              const statusDiv = document.getElementById("wifi-status");
              if (data.connected) {
                statusDiv.innerHTML = `
                <strong>‚úÖ Connected</strong><br>
                SSID: ${data.ssid || "N/A"}<br>
                Signal: ${data.signal || "N/A"}%
              `;
              } else {
                statusDiv.innerHTML = `<strong>‚ùå Not Connected</strong>`;
              }
            }
          } catch (error) {
            console.error("Error fetching WiFi status:", error);
          }
        }

        async function scanWifi() {
          const scanBtn = document.getElementById("scan-btn");
          const wifiList = document.getElementById("wifi-list");

          scanBtn.disabled = true;
          scanBtn.textContent = "üîÑ Scanning...";
          wifiList.innerHTML =
            "<p style='text-align:center;padding:20px;'>Scanning for networks...</p>";

          try {
            const response = await fetch("/api/wifi/scan");
            if (response.ok) {
              const networks = await response.json();
              displayWifiNetworks(networks);
            } else {
              wifiList.innerHTML =
                "<p style='text-align:center;padding:20px;color:#f5576c;'>Failed to scan networks</p>";
            }
          } catch (error) {
            console.error("Error scanning WiFi:", error);
            wifiList.innerHTML =
              "<p style='text-align:center;padding:20px;color:#f5576c;'>Error: " +
              error.message +
              "</p>";
          } finally {
            scanBtn.disabled = false;
            scanBtn.textContent = "üîÑ Scan Networks";
          }
        }

        function displayWifiNetworks(networks) {
          const wifiList = document.getElementById("wifi-list");

          if (networks.length === 0) {
            wifiList.innerHTML =
              "<p style='text-align:center;padding:20px;'>No networks found</p>";
            return;
          }

          wifiList.innerHTML = networks
            .map((network, index) => {
              const isConnected = network.connected;
              const signalBars =
                network.signal > 75
                  ? "üì∂"
                  : network.signal > 50
                  ? "üì∂"
                  : network.signal > 25
                  ? "üì°"
                  : "üì°";
              const security = network.security ? "üîí" : "üîì";

              return `
            <div class="wifi-network" id="network-${index}">
              <div class="wifi-info">
                <div class="wifi-ssid">${signalBars} ${
                network.ssid
              } ${security}</div>
                <div class="wifi-details">
                  Signal: ${network.signal}% | ${
                network.security ? "Secured" : "Open"
              }
                  ${
                    isConnected
                      ? ' | <strong style="color:#28a745;">Connected</strong>'
                      : ""
                  }
                </div>
              </div>
              <button
                class="wifi-connect-btn ${isConnected ? "connected" : ""}"
                onclick="showConnectForm(${index}, '${network.ssid}', ${
                network.security
              })"
                ${isConnected ? "disabled" : ""}
              >
                ${isConnected ? "‚úì Connected" : "Connect"}
              </button>
            </div>
            <div id="connect-form-${index}" style="display:none;"></div>
          `;
            })
            .join("");
        }

        function showConnectForm(index, ssid, requiresPassword) {
          const formDiv = document.getElementById(`connect-form-${index}`);

          if (formDiv.style.display === "block") {
            formDiv.style.display = "none";
            return;
          }

          // Hide all other forms
          document.querySelectorAll('[id^="connect-form-"]').forEach((div) => {
            div.style.display = "none";
          });

          formDiv.style.display = "block";
          formDiv.innerHTML = `
          <div class="wifi-connect-form">
            <strong>Connect to: ${ssid}</strong>
            ${
              requiresPassword
                ? `
              <input
                type="password"
                id="wifi-password-${index}"
                placeholder="Enter password"
                autocomplete="off"
              />
            `
                : "<p>This network is open (no password required)</p>"
            }
            <div>
              <button class="wifi-connect-btn" onclick="connectToWifi('${ssid}', ${index}, ${requiresPassword})">
                Connect
              </button>
              <button class="btn-copy" onclick="showConnectForm(${index}, '${ssid}', ${requiresPassword})">
                Cancel
              </button>
            </div>
            <div id="connect-status-${index}" style="margin-top:10px;font-size:12px;"></div>
          </div>
        `;
        }

        async function connectToWifi(ssid, index, requiresPassword) {
          const statusDiv = document.getElementById(`connect-status-${index}`);
          const password = requiresPassword
            ? document.getElementById(`wifi-password-${index}`).value
            : "";

          if (requiresPassword && !password) {
            statusDiv.innerHTML =
              '<span style="color:#f5576c;">Please enter a password</span>';
            return;
          }

          statusDiv.innerHTML =
            '<span style="color:#667eea;">Connecting...</span>';

          try {
            const response = await fetch("/api/wifi/connect", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ssid, password }),
            });

            const result = await response.json();

            if (response.ok && result.success) {
              statusDiv.innerHTML =
                '<span style="color:#28a745;">‚úì Connected successfully!</span>';
              setTimeout(() => {
                fetchWifiStatus();
                scanWifi();
              }, 2000);
            } else {
              statusDiv.innerHTML =
                '<span style="color:#f5576c;">‚úó ' +
                (result.message || "Connection failed") +
                "</span>";
            }
          } catch (error) {
            console.error("Error connecting to WiFi:", error);
            statusDiv.innerHTML =
              '<span style="color:#f5576c;">‚úó Error: ' +
              error.message +
              "</span>";
          }
        }

        async function fetchScoreboard() {
          try {
            const response = await fetch("/api/scores");
            if (response.ok) {
              const scores = await response.json();
              updateScoreboard(scores);
            }
          } catch (error) {
            console.error("Error loading scoreboard:", error);
          }
        }

        function updateScoreboard(scores) {
          const tbody = document.getElementById("scoreboard-body");

          if (scores.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="3" style="text-align: center; color: #999;">Noch keine Scores</td></tr>';
            return;
          }

          const medals = ["ü•á", "ü•à", "ü•â"];
          tbody.innerHTML = scores
            .map((score, index) => {
              const date = new Date(score.timestamp);
              const medal = index < 3 ? medals[index] : `#${index + 1}`;
              return `
            <tr>
              <td><span class="rank-medal">${medal}</span></td>
              <td><span class="score-value">${score.score}</span></td>
              <td>${date.toLocaleDateString("de-DE")} ${date.toLocaleTimeString(
                "de-DE",
                { hour: "2-digit", minute: "2-digit" }
              )}</td>
            </tr>
          `;
            })
            .join("");
        }

        async function fetchSystemInfo() {
          try {
            const response = await fetch("/api/system-info");
            if (response.ok) {
              const info = await response.json();
              updateSystemInfo(info);
            }
          } catch (error) {
            console.error("Error loading system info:", error);
          }
        }

        function updateSystemInfo(info) {
          const container = document.getElementById("system-info");
          container.innerHTML = `
          <div class="info-row">
            <span class="info-label">ÔøΩ OS</span>
            <span class="info-value">${info.os.distro}</span>
          </div>
          <div class="info-row">
            <span class="info-label">üè∑Ô∏è Hostname</span>
            <span class="info-value">${info.os.hostname}</span>
          </div>
          <div class="info-row">
            <span class="info-label">‚è±Ô∏è Uptime</span>
            <span class="info-value">${formatUptime(info.os.uptime)}</span>
          </div>
          <div class="admin-buttons" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <button class="btn-admin" onclick="openSessionsModal()" style="background: #667eea; color: white;">
                üîê Sessions (<span id="session-count-btn">${currentSessionCount}</span>)
              </button>
              <button class="btn-admin" onclick="openLogsModal()" style="background: #667eea; color: white;">
                üìã Logs
              </button>
              <button class="btn-admin btn-restart" onclick="restartServer()">
                üîÑ Neustart
              </button>
              <button class="btn-admin btn-shutdown" onclick="shutdownServer()">
                ‚õî Beenden
              </button>
          </div>
        `;
        }

        function formatUptime(minutes) {
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          const days = Math.floor(hours / 24);
          const hrs = hours % 24;

          if (days > 0) {
            return `${days}d ${hrs}h ${mins}m`;
          } else if (hours > 0) {
            return `${hours}h ${mins}m`;
          } else {
            return `${minutes}m`;
          }
        }

        async function logout() {
          try {
            await fetch("/api/logout", { method: "POST" });
            window.location.href = "/";
          } catch (error) {
            console.error("Error during logout:", error);
            window.location.href = "/";
          }
        }

        async function restartServer() {
          if (!confirm("M√∂chten Sie den Server wirklich neu starten?")) {
            return;
          }

          try {
            const response = await fetch("/api/admin/restart", {
              method: "POST",
            });
            if (response.ok) {
              alert("Server wird neu gestartet...");
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            }
          } catch (error) {
            console.error("Error restarting server:", error);
            alert("Fehler beim Neustart");
          }
        }

        async function shutdownServer() {
          if (!confirm("M√∂chten Sie den Server wirklich beenden?")) {
            return;
          }

          try {
            const response = await fetch("/api/admin/shutdown", {
              method: "POST",
            });
            if (response.ok) {
              alert("Server wird beendet...");
            }
          } catch (error) {
            console.error("Error shutting down server:", error);
          }
        }

        // Logs Modal Functions
        function openLogsModal() {
          document.getElementById("logs-modal").style.display = "block";
          refreshLogs();
        }

        function closeLogsModal() {
          document.getElementById("logs-modal").style.display = "none";
        }

        async function refreshLogs() {
          try {
            const response = await fetch("/api/logs");
            if (!response.ok) throw new Error("Failed to fetch logs");

            const data = await response.json();
            displayLogs(data.logs);
          } catch (error) {
            console.error("Error fetching logs:", error);
            document.getElementById("logs-container").innerHTML =
              '<div style="color: #ff6b6b">Error loading logs: ' +
              error.message +
              "</div>";
          }
        }

        function displayLogs(logs) {
          const container = document.getElementById("logs-container");
          const autoScroll =
            document.getElementById("auto-scroll-logs").checked;

          if (!logs || logs.length === 0) {
            container.innerHTML =
              '<div style="text-align: center; color: #888">No logs available</div>';
            return;
          }

          const logHtml = logs
            .map((log) => {
              const time = new Date(log.timestamp).toLocaleTimeString("de-DE");
              let color = "#d4d4d4";
              let icon = "‚ÑπÔ∏è";

              if (log.level === "error") {
                color = "#ff6b6b";
                icon = "‚ùå";
              } else if (log.level === "warn") {
                color = "#ffd93d";
                icon = "‚ö†Ô∏è";
              }

              return `<div style="color: ${color}; margin-bottom: 4px">
              <span style="color: #888">[${time}]</span>
              ${icon}
              <span>${escapeHtml(log.message)}</span>
            </div>`;
            })
            .join("");

          container.innerHTML = logHtml;

          if (autoScroll) {
            container.scrollTop = container.scrollHeight;
          }
        }

        function escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        async function clearServerLogs() {
          if (!confirm("Are you sure you want to clear all server logs?")) {
            return;
          }

          try {
            const response = await fetch("/api/logs/clear", {
              method: "POST",
            });

            if (response.ok) {
              refreshLogs();
            } else {
              throw new Error("Failed to clear logs");
            }
          } catch (error) {
            console.error("Error clearing logs:", error);
            alert("Error clearing logs: " + error.message);
          }
        }

        // Speedtest Functions
        async function setSpeedtestInterval() {
          const select = document.getElementById("speedtest-interval");
          const interval = select.value;

          try {
            const response = await fetch("/api/speedtest/interval", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `interval=${interval}`,
            });

            if (response.ok) {
              console.log(`Speed test interval set to ${interval} seconds`);
            }
          } catch (error) {
            console.error("Error setting interval:", error);
          }
        }

        async function fetchSpeedtestHistory() {
          try {
            const response = await fetch("/api/speedtest/history");
            if (response.ok) {
              const data = await response.json();
              updateSpeedtestChart(data.history);
              updateSpeedtestResults(data.history);
            }
          } catch (error) {
            console.error("Error fetching speedtest history:", error);
          }
        }

        function updateSpeedtestChart(history) {
          if (history.length === 0) return;

          const ctx = document.getElementById("speedtest-chart");
          const labels = history.map((entry) =>
            new Date(entry.timestamp).toLocaleTimeString("de-DE")
          );

          const datasets = [];

          if (speedtestFocusMode === "all" || speedtestFocusMode === "ping") {
            datasets.push({
              label: "Ping (ms)",
              data: history.map((entry) => entry.ping),
              borderColor: "#667eea",
              backgroundColor: "rgba(102, 126, 234, 0.1)",
              yAxisID: "y-ping",
              hidden:
                speedtestFocusMode !== "all" && speedtestFocusMode !== "ping",
            });
          }

          if (
            speedtestFocusMode === "all" ||
            speedtestFocusMode === "download"
          ) {
            datasets.push({
              label: "Download (Mbit/s)",
              data: history.map((entry) => entry.download),
              borderColor: "#28a745",
              backgroundColor: "rgba(40, 167, 69, 0.1)",
              yAxisID: "y-speed",
              hidden:
                speedtestFocusMode !== "all" &&
                speedtestFocusMode !== "download",
            });
          }

          if (speedtestFocusMode === "all" || speedtestFocusMode === "upload") {
            datasets.push({
              label: "Upload (Mbit/s)",
              data: history.map((entry) => entry.upload),
              borderColor: "#f5576c",
              backgroundColor: "rgba(245, 87, 108, 0.1)",
              yAxisID: "y-speed",
              hidden:
                speedtestFocusMode !== "all" && speedtestFocusMode !== "upload",
            });
          }

          if (speedtestChart) {
            speedtestChart.destroy();
          }

          speedtestChart = new Chart(ctx, {
            type: "line",
            data: { labels, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              scales: {
                "y-ping": {
                  type: "linear",
                  display:
                    speedtestFocusMode === "all" ||
                    speedtestFocusMode === "ping",
                  position: "left",
                  title: {
                    display: true,
                    text: "Ping (ms)",
                  },
                },
                "y-speed": {
                  type: "linear",
                  display:
                    speedtestFocusMode === "all" ||
                    speedtestFocusMode === "download" ||
                    speedtestFocusMode === "upload",
                  position: speedtestFocusMode === "all" ? "right" : "left",
                  title: {
                    display: true,
                    text: "Speed (Mbit/s)",
                  },
                  grid: {
                    drawOnChartArea: speedtestFocusMode !== "all",
                  },
                },
              },
            },
          });
        }

        function updateSpeedtestResults(history) {
          if (history.length === 0) return;

          const latest = history[history.length - 1];
          const resultsDiv = document.getElementById("speedtest-results");

          let html = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #888; margin-bottom: 5px;">LATEST PING</div>
              <div style="font-size: 28px; font-weight: bold; color: #667eea;">${
                latest.ping || "--"
              }</div>
              <div style="font-size: 12px; color: #888;">ms</div>
            </div>
        `;

          if (latest.download !== null) {
            html += `
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #888; margin-bottom: 5px;">LATEST DOWNLOAD</div>
              <div style="font-size: 28px; font-weight: bold; color: #28a745;">${latest.download}</div>
              <div style="font-size: 12px; color: #888;">Mbit/s</div>
            </div>
          `;
          }

          if (latest.upload !== null) {
            html += `
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size: 11px; color: #888; margin-bottom: 5px;">LATEST UPLOAD</div>
              <div style="font-size: 28px; font-weight: bold; color: #f5576c;">${latest.upload}</div>
              <div style="font-size: 12px; color: #888;">Mbit/s</div>
            </div>
          `;
          }

          html += `</div>`;
          html += `<p style="margin-top: 10px; font-size: 11px; color: #aaa; text-align: center;">Last test: ${new Date(
            latest.timestamp
          ).toLocaleString("de-DE")}</p>`;
          html += `<p style="margin-top: 5px; font-size: 11px; color: #aaa; text-align: center;">Total tests: ${history.length}</p>`;

          resultsDiv.innerHTML = html;
        }

        function focusSpeedtestMetric(metric) {
          speedtestFocusMode = metric;

          // Update button states
          document.getElementById("focus-all").style.background =
            metric === "all" ? "#667eea" : "#888";
          document.getElementById("focus-ping").style.background =
            metric === "ping" ? "#667eea" : "#888";
          document.getElementById("focus-download").style.background =
            metric === "download" ? "#667eea" : "#888";
          document.getElementById("focus-upload").style.background =
            metric === "upload" ? "#667eea" : "#888";

          // Refresh chart
          fetchSpeedtestHistory();
        }

        async function fetchSpeedtestStatus() {
          try {
            const response = await fetch("/api/admin/speedtest/status");
            if (response.ok) {
              const data = await response.json();
              const toggle = document.getElementById("auto-speedtest-toggle");
              const warning = document.getElementById("speedtest-warning");
              if (toggle) {
                toggle.checked = data.enabled;
              }
              if (warning) {
                warning.style.display = data.enabled ? "block" : "none";
              }
            }
          } catch (error) {
            console.error("Error fetching speedtest status:", error);
          }
        }

        async function toggleAutoSpeedtest(enabled) {
          try {
            const response = await fetch("/api/admin/speedtest/toggle", {
              method: "POST",
              body: new URLSearchParams({ enabled: enabled }),
            });
            if (response.ok) {
              const data = await response.json();
              const warning = document.getElementById("speedtest-warning");
              if (warning) {
                warning.style.display = data.enabled ? "block" : "none";
              }
              if (data.enabled) {
                fetchSpeedtestHistory();
              }
            } else {
              console.error("Failed to toggle speedtest");
              document.getElementById("auto-speedtest-toggle").checked =
                !enabled;
            }
          } catch (error) {
            console.error("Error toggling speedtest:", error);
            document.getElementById("auto-speedtest-toggle").checked = !enabled;
          }
        }

        // Initial fetch
        fetchMetrics();
        // fetchScoreboard(); // Moved to Game Admin
        fetchSystemInfo();
        fetchSessions();
        fetchSpeedtestHistory();
        fetchSpeedtestStatus();

        // Update every 1 second
        updateInterval = setInterval(fetchMetrics, 1000);

        // Update scoreboard every 10 seconds
        // setInterval(fetchScoreboard, 10000); // Moved to Game Admin

        // Update sessions count every 5 seconds
        setInterval(fetchSessions, 5000);

        // Update speedtest history every 10 seconds
        setInterval(fetchSpeedtestHistory, 10000);

        // Terminal Logic
        const terminalOutput = document.getElementById("terminal-output");

        function appendLog(log) {
          const line = document.createElement("div");
          line.style.marginBottom = "2px";

          const timestamp = new Date(log.timestamp).toLocaleTimeString();
          let color = "#d4d4d4"; // Default
          if (log.level === "warn") color = "#cca700";
          if (log.level === "error") color = "#f14c4c";

          line.innerHTML = `<span style="color: #569cd6;">[${timestamp}]</span> <span style="color: ${color};">[${log.level.toUpperCase()}]</span> ${
            log.message
          }`;
          terminalOutput.appendChild(line);
          terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        function initTerminal() {
          const eventSource = new EventSource("/api/logs/stream");

          eventSource.onmessage = (event) => {
            const log = JSON.parse(event.data);
            appendLog(log);
          };

          eventSource.onerror = (err) => {
            console.error("EventSource failed:", err);
            eventSource.close();
            // Retry after 5 seconds
            setTimeout(initTerminal, 5000);
          };
        }

        async function clearTerminal() {
          try {
            await fetch("/api/logs/clear", { method: "POST" });
            terminalOutput.innerHTML = "";
          } catch (error) {
            console.error("Error clearing logs:", error);
          }
        }

        async function setLogLevel(level) {
          try {
            await fetch("/api/logs/level", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `level=${level}`,
            });
          } catch (error) {
            console.error("Error setting log level:", error);
          }
        }

        // Initialize Terminal
        initTerminal();

        // Cleanup on page unload
        window.addEventListener("beforeunload", () => {
          if (updateInterval) {
            clearInterval(updateInterval);
          }
        });
      </script>
    </div>
    <!-- End main-content -->
  </body>
</html>
